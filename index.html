<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en-US"> <!-- This element is the root element of an HTML page -->

<head> 
    <title>berniweb</title>
    <meta charset="UTF-8">
    <meta name="description" content="Personal website (learning D3)">
    <meta name="keywords" content="HTML, CSS, XML, JavaScript, D3">
    <meta name="author" content="Bernat Bramon Mora">
    <!--<meta http-equiv="refresh" content="100">-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">

    <script defer src="https://use.fontawesome.com/releases/v5.0.10/js/all.js" integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+"
        crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css">
    <link rel="stylesheet" href="othercss/main.css">

</head>

<body>

<div id="container" class="svg-container">
    <!--<svg xmlns="http://www.w3.org/2000/svg"></svg>
    <div id="content"></div>-->

</div>

<!--<script type="text/javascript" src="d3/d3.js"></script>-->
<script  src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
	function loadHtml(clickedBar)
	{

	     $.ajax({
		type:"GET",
		url: clickedBar,
		mimeType: "text/html; charset=utf-8",
		success: function(result){
		    $("#htmlcontent").html(result);
                    }
		});
	}


    var svg = d3.select("div#container")
            .append("svg").attr("preserveAspectRatio", "xMinYMin meet").attr("viewBox", "0 0 960 960").classed("svg-content", true),
        margin = 20,
        smallr = 3.5,
        fzinitial = "25px",
        fzfocus = "70px",
        diameter = 960

    if (screen.width<400){
        fzinitial = "30px";
    }

    var gtext = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

      gtext.selectAll("text").data([1], function(d) {return d}).enter().append("text")
        .attr("id", "firstpage1")
        .text("Bernat Bramon Mora")
        .attr("x", 0)             
        .attr("y", -diameter/3.2)
        .attr("text-anchor", "middle")
        .style("font-family", "League Mono");


      gtext.selectAll("text").data([2], function(d) {return d}).enter().append("text")
        .attr("id", "firstpage2")
        .attr("x", 0)             
        .attr("y", -diameter/4.1)
        .attr("text-anchor", "middle")  
        .style("font-family", "League Mono")
        .style("font-style", "italic")
        .text("learning D3.js");

      gtext.selectAll("text").data([3], function(d) {return d}).enter().append("text")
        .attr("id", "firstpage2")
        .attr("x", 0)             
        .attr("y", +diameter/4)
        .attr("text-anchor", "middle")  
        .style("font-family", "League Mono")
        .style("font-style", "italic")
        .text("bernat.bramon@gmail.com");


    var g = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

    var color = d3.scaleLinear()
        .domain([0, 4])
        .range(["hsl(225,80%,80%)", "white"])
        .interpolate(d3.interpolateHcl);

    var pack = d3.pack()
        .size([diameter - margin, diameter - margin])
        .padding(function(d) { 
        return d.data.padding || 2;
        });

    d3.json("flare.json", function(error, root) {
      if (error) throw error;

      var root = d3.hierarchy(root)
          .sum(function(d) { return d.size; })
            .sort(function(a, b) {
                                   return b.data.value-a.data.value; });

      var focus = root,
          nodes_obj = pack(root).descendants(),
          view;


    //Pattern definitions-------------------------------------------------------

      
      var div = d3.select("div#container").append("div").attr("id","content").style("z-index", -2000)//.style("height", svg.style("height"))
                  .insert("div").attr("id", "htmlcontent");

      var nodeEnter = g.selectAll("g.node")
        .data(nodes_obj)
        .enter().append("svg:g")
        .attr("id", function(d,i){return "circle-"+i;})
        .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
        //.style("fill", function(d) { return d.depth==1? "url(#grump_avatar)":color(d.depth); })
        .on("click", function(d) {
            if (focus !== d){
                          zoom(d);
                          d3.event.stopPropagation()};
            })
        .style("display", function(d) { return (d.depth<=focus.depth+1) ? "inline" : "none"; })
        .style("stroke", function(d) { return d.data.stroke;})
        .on("mouseover", function(d) { if (focus==root || focus.depth==1){ d3.select("#foto-0").attr("xlink:href", "images/surfer_blur2.png");} })
        .on("mouseout", function(d) { if (focus==root || focus.depth==1){ d3.select("#foto-0").attr("xlink:href", "images/surfer.png"); }});

      var circle = nodeEnter.append("svg:circle")
        .attr("r", function(d) {d.size})
        .style("fill", function(d) { return d.data.color; })
        .attr("x", function(d) {d.data.x})
        .attr("y", function(d) {d.data.y})
        .style("fill-opacity", function(d) { return (d.depth<=focus.depth) ? 1 : 0; })
        .style("display", function(d) { return (d.depth<=focus.depth+1) ? "inline" : "none"; });


      // Append images
      var images = nodeEnter
        .filter(function(d) {return d.data.switch=="on"})
        .append("svg:image")
        .attr("id", function(d,i) {return "foto-"+i;})
        .attr("xlink:href",  function(d) { return d.data.img;})
        .attr("height", diameter-margin*2)
        .attr("width", diameter-margin*2)
        .attr("x", 0)
        .attr("y", 0)
        .attr("pointer-events", "none")
        .style("opacity", function(d) { return (d.depth<=focus.depth) ? 1 : 0; });

      var text = g.selectAll("text")
        .data(nodes_obj)
        .enter()
        .filter(function(d){return d.data.children;})
        .append("text")
        .attr("class", "label")
        .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
        .style("display", function(d) { return d.parent === root ? "inline" : "none"; })
        .style("text-shadow", "none")
        .style("font-size", fzinitial)
        .text(function(d) { return d.data.name; })
        .attr("dy", function(d) { return d.data.position; });

      var node = g.selectAll("g.node,text.label");


      svg.style("background", "none")
          .on("click", function() {
                    zoom(root);
                    });

      zoomTo([root.x, root.y, root.r * smallr *2 + margin]);

      function zoom(d) {
            var focus0 = focus; focus = d;
            var slapse=500, mlapse=1500, llapse=2000;

            console.log(focus.depth);

            var trans = d3.transition()
            .duration(d3.event.altKey ? 7500 : mlapse)
            .delay(function(d){
              if(focus==root){
                  return slapse*1.5;
              }else{
                  return slapse;
              }
            })
            .tween("zoom", function(d) {
              if(focus==root){
                  var i = d3.interpolateZoom(view, [focus.data.x, focus.data.y, focus.r *smallr* 2 + margin]);
                  return function(t) { zoomTo(i(t)); };
              }else{
                  if(focus.depth==2){
                  var i = d3.interpolateZoom(view, [focus.data.x, focus.data.y, focus.r * 1.7  + margin]);
                  }else if(focus.depth>2){
                  var i = d3.interpolateZoom(view, [focus.data.x, focus.data.y, focus.r * 1.6  + margin]);
                  }else{
                  var i = d3.interpolateZoom(view, [focus.data.x, focus.data.y, focus.r * 2 + margin]);
                  }
                  return function(t) { zoomTo(i(t)); };
              }
            });

            trans.selectAll("g.node")
            .filter(function(d) { return (d.parent===focus)  || this.style.display === "inline"; })
            .delay(slapse)
            .style("fill-opacity", function(d) { return (d.depth<=focus.depth+1) ? 1 : 0; })
            .on("start", function(d) { if (d.depth<=focus.depth+1)  this.style.display = "inline"; })
            .on("end", function(d) { if (d.depth>focus.depth+1)  this.style.display = "none"; });

            if (focus===root){
                trans.selectAll("circle")
                .filter(function(d) { return (d.parent===focus)  || this.style.display === "inline"; })
                .delay(function(d) {return (d.depth==1) ? 0:slapse; })
                .style("fill-opacity", function(d) { return (d.depth<=focus.depth) ? 1 : 0; })
                .on("start", function(d) { if (d.depth<=focus.depth+1)  this.style.display = "inline"; })
                .on("end", function(d) { if (d.depth>focus.depth+1)  this.style.display = "none"; });

                trans.selectAll("image")
                .filter(function(d) { if (focus.depth>=3){
                                          return ((d.depth<=focus.depth+1)  || this.style.display === "inline") && (d.data.name!="Projects"); 
                                      }else{
                                          return (d.depth<=focus.depth+1)  || this.style.display === "inline"; 
                                      }})
                .delay(function(d){return (d.depth==1)? mlapse:slapse})
                .ease(d3.easeLinear).style("opacity", function(d) { return (d.depth<=focus.depth) ? 1 : 0 })
                .on("start", function(d) { if (d.depth<=focus.depth)  this.style.display = "inline"; })
                .on("end", function(d) { if (d.depth>focus.depth)  this.style.display = "none"; });
            }else{
                trans.selectAll("circle")
                .filter(function(d) { return (d.parent===focus)  || this.style.display === "inline"; })
                .delay(function(d){return (d.depth==1)? llapse:slapse})
                .style("fill-opacity", function(d) { return (d.depth<=focus.depth+1) ? 1 : 0; })
                .on("start", function(d) { if (d.depth<=focus.depth+1)  this.style.display = "inline"; })
                .on("end", function(d) { if (d.depth>focus.depth+1)  this.style.display = "none"; });

                trans.selectAll("image")
                .filter(function(d) { if (focus.depth>=3){
                                          return ((d.depth<=focus.depth+1)  || this.style.display === "inline") && (d.data.name!="Projects"); 
                                      }else{
                                          return (d.depth<=focus.depth+1)  || this.style.display === "inline"; 
                                      }})
                .delay(function(d){return (d.depth<=1)? 0:slapse})
                .ease(d3.easeLinear).style("opacity", function(d) { return (d.depth<=focus.depth+1) ? 1 : 0 })
                .on("start", function(d) { if (d.depth<=focus.depth+1)  this.style.display = "inline"; })
                .on("end", function(d) { if (d.depth>focus.depth+1)  this.style.display = "none"; });
            }

            if(focus.data.name=="Projects"){
            d3.select("#foto-4").transition().delay(slapse).duration(2*slapse).ease(d3.easeLinear)
              .style("opacity", 0);
            }

            trans.selectAll("text")
            .filter(function(d) { return d.parent === focus && this.style.display !== "inline"; })
            .delay(mlapse)
            .duration(llapse)
            .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
            .styleTween("display", function() { return d3.interpolate("none", "inline"); });

            trans.selectAll("text")
            .filter(function(d) { return (this.style.display === "inline"); })
            .delay(function(d){return (d.depth<=focus.depth+1 || d===focus)? 300 : slapse; })
            .style("fill-opacity", function(d) {return (d.depth<=focus.depth+1 || d===focus)? 1 : 0; })
            .on("start", function(d) {this.style.diplay = "inline"})
            .on("end", function(d) { if (d.depth>focus.depth+1 && d!==focus) this.style.display = "none"; })
            .attr("dy", function(d) {return  (d.depth<focus.depth)? -600 : d.data.position;})
            .style("font-size", function(d) {return  (d.depth<focus.depth)? fzfocus*2 : fzinitial;});


            trans.selectAll("text")
            .filter(function(d) { return (this.style.display === "inline") && (d===focus); }).delay(slapse+100)
            .attrTween("dy", function(d) { if(focus0.depth==3){return d3.interpolate(-600, -300);}
                                          else{return d3.interpolate(d.data.position, -300);}
                                        })
            .styleTween("font-size", function(){ if(focus0.depth==3){return d3.interpolate(fzfocus*2, fzfocus);}
                                          else{return d3.interpolate(fzinitial, fzfocus);}});


            /*d3.selectAll("images").filter(function(d) { return (d.depth<=focus.depth+1)  || this.style.display === "inline"; })
            .transition().delay(slapse).duration(mlapse).ease(d3.easeLinear)
            .style("opacity", function(d) { return (d==focus) ? 1 : 0; });*/

            var maincircle = d3.selectAll("#foto-0");

            if(focus.children.length==1 && focus!==root && focus.data.name!="Projects"){
               d3.select("#content").style("z-index", 1000);
               d3.select("#htmlcontent").each(function(d){loadHtml(focus.data.name+".html")})
                 .transition().delay(mlapse+slapse).style("display", "inline-block");
            }else{
               d3.select("#htmlcontent").style("display", "none");
               d3.select("#content").style("z-index", -1000);
            }

            if(focus.depth==0){
               d3.select("#firstpage1").transition().delay(mlapse).style("opacity", 1);
               d3.selectAll("#firstpage2").transition().delay(mlapse).style("opacity", 1);
               maincircle.attr("xlink:href", "images/surfer2.png");
               d3.selectAll("#icons3").transition().delay(mlapse).style("opacity", 1);
            }else{
               d3.select("#firstpage1").transition().delay(0).duration(mlapse).style("opacity", 0);
               d3.selectAll("#firstpage2").transition().delay(0).duration(mlapse).style("opacity", 0);
               maincircle.attr("xlink:href", "images/surfer_blur2.png");
               d3.selectAll("#icons3").transition().delay(0).duration(mlapse).style("opacity", 0);
            }

            /*if(focus.depth==0){
                d3.select("body").transition().delay(1000).duration(1000).style("background-color", "white");
            }else if(focus.depth==1){
                d3.select("body").transition().delay(1000).duration(1000).style("background-color", "#969696");
            }else{
                d3.select("body").transition().delay(1000).duration(1000).style("background-color", "#2e3436");
            }*/
            if(focus.depth>1){
                d3.select("body").transition().delay(1000).duration(1000).style("background-color", "#2e3436");
            }else{
                d3.select("body").transition().delay(500).duration(1000).style("background-color", "white");
            }
            
            
      }


      function zoomTo(v) {
        var k = diameter / v[2]; view = v;
        //node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
        node.attr("transform", function(d) { return "translate(" + (d.data.x - v[0]) * k + "," + (d.data.y - v[1]) * k + ")"; });
        circle.attr("r", function(d) { return d.r * k; });
        images.attr("width", function(d) { return d.r * 1.98 * k; });
        images.attr("height", function(d) { return d.r *  1.98 * k; });
        images.attr("transform", function(d) { return "translate(" + -0.5 * (d.r * 1.98 * k) + "," + -0.5 * (d.r * 1.98 * k) + ")"; });

      }
    });



</script>

</body>
</html>
