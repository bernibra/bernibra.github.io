<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en-US"> <!-- This element is the root element of an HTML page -->

<head> 
    <title>berniweb</title>
    <meta charset="UTF-8">
    <meta name="description" content="Personal website (learning D3)">
    <meta name="keywords" content="HTML, CSS, XML, JavaScript, D3">
    <meta name="author" content="Bernat Bramon Mora">
    <!--<meta http-equiv="refresh" content="100">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <style>

        body {
          margin:none;
        }

        .node {
          cursor: pointer;
          stroke-width: 1.5px;
        }

        .node:hover {
          stroke: #000;
          stroke-width: 1.5px;
        /*idea: earth type shadding*/
        }

        .node--leaf {
          fill: white;
        }

        .label {
          font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
          text-anchor: middle;
          text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
        }

        .label,
        .node--root,
        .node--leaf {
          pointer-events: none;
        }

        .clearfix {
            clear: both;
        }

        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            vertical-align: top;
            overflow: hidden;
        }
        .svg-content {
            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
        }
        iframe {
            position: relative;
            float:center;
            padding: 0%;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            display: none;
            pointer-events: auto;
            border: none;
        }

        #content {
           position: absolute;
           float:center;
           padding-top:27%;
           padding-right:10%;
           padding-bottom:18%;
           padding-left:10%;
           left: 0px;
           top: 0px;
           /* absolute position implies no width and height */
           width: 80%;
           height: 55%;
           pointer-events: none;
        }

    </style>
</head>

<body>
<div id="container" class="svg-container">
    <!--<svg xmlns="http://www.w3.org/2000/svg"></svg>
    <div id="content"></div>-->
</div>


<script src="https://d3js.org/d3.v4.min.js"></script>
<script>


    var svg = d3.select("div#container")
            .append("svg").attr("preserveAspectRatio", "xMinYMin meet").attr("viewBox", "0 0 960 960").classed("svg-content", true),
        margin = 20,
        smallr = 3.5,
        fzinitial = "30px",
        fzfocus = "90px",
        diameter = 960

    var gtext = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

      gtext.selectAll("text").data([1], function(d) {return d}).enter().append("text")
        .attr("id", "firstpage")
        .attr("x", 0)             
        .attr("y", -diameter/3.2)
        .attr("text-anchor", "middle")  
        .style("font-size", "38px") 
        .style("font-type", "Andale Mono")
        .text("Bernat Bramon Mora");


      gtext.selectAll("text").data([2], function(d) {return d}).enter().append("text")
        .attr("id", "firstpage")
        .attr("x", 0)             
        .attr("y", -diameter/3.8)
        .attr("text-anchor", "middle")  
        .style("font-size", "18px") 
        .style("font-type", "Andale Mono")
        .style("font-style", "italic")
        .text("learning D3.js");

      gtext.selectAll("text").data([3], function(d) {return d}).enter().append("text")
        .attr("id", "firstpage")
        .attr("x", 0)             
        .attr("y", +diameter/4)
        .attr("text-anchor", "middle")  
        .style("font-size", "18px")
        .style("font-type", "Andale Mono")
        .style("font-style", "italic")
        .text("bernat.bramon@gmail.com");


    var g = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

    var color = d3.scaleLinear()
        .domain([-1, 5])
        .range(["hsl(225,80%,80%)", "white"])
        .interpolate(d3.interpolateHcl);

    var pack = d3.pack()
        .size([diameter - margin, diameter - margin])
        .padding(function(d) { 
        return d.data.padding || 2; 
        });

    d3.json("flare.json", function(error, root) {
      if (error) throw error;

      var root = d3.hierarchy(root)
          .sum(function(d) { return d.size; })
          .sort(function(a, b) { return b.value - a.value; });

      var focus = root,
          nodes_obj = pack(root).descendants(),
          view;


    //Pattern definitions-------------------------------------------------------

    var defs = svg.append('svg:defs');
            defs.append("svg:pattern")
            .attr("id", "grump_avatar")
            .attr("width", 1)
            .attr("height", 1)
                    .attr('patternContentUnits', 'objectBoundingBox')
            .append("svg:image")
            .attr("xlink:href", "images/surfer.png")
            .attr("width", 1)
            .attr("height", 1)
                .attr("x", 0)
                .attr("y", 0)
            .attr("preserveAspectRatio", "xMinYMin slice");

    var defs = svg.append('svg:defs');
            defs.append("svg:pattern")
            .attr("id", "grump_avatar_blur")
            .attr("width", 1)
            .attr("height", 1)
                    .attr('patternContentUnits', 'objectBoundingBox')
            .append("svg:image")
            .attr("xlink:href", "images/surfer_blur2.png")
            .attr("width", 1)
            .attr("height", 1)
                .attr("x", 0)
                .attr("y", 0)
            .attr("preserveAspectRatio", "xMinYMin slice");

    //Pattern definitions-------------------------------------------------------

      var div = d3.select("div#container").append("div").attr("id","content")
        .insert("iframe").attr("id", "htmlfile").attr("pointer-events", "auto")
        .style("z-index", -1000);

      var circle = g.selectAll("circle")
        .data(nodes_obj)
        .enter().append("circle")
        .attr("id", function(d,i){return "circle-"+i;})
        .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
        .style("fill", function(d) { return d.depth==1? "url(#grump_avatar)":color(d.depth); })
        .on("click", function(d) {
            if (focus !== d){
                          zoom(d);
                          d3.event.stopPropagation()};
            })
        .on("mouseover", function(d) { if(focus.depth==0 && d.depth==1) d3.select(this).style("fill", "url(#grump_avatar_blur)"); })
        .on("mouseout", function(d) { if(focus.depth==0 && d.depth==1) d3.select(this).style("fill", "url(#grump_avatar)"); })
        .style("display", function(d) { return (d.depth<=focus.depth+1) ? "inline" : "none"; });

      var text = g.selectAll("text")
        .data(nodes_obj)
        .enter()
        .filter(function(d){return d.data.children;})
        .append("text")
        .attr("class", "label")
        .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
        .style("display", function(d) { return d.parent === root ? "inline" : "none"; })
        .style("font-family", "georgia")
        .style("text-shadow", "none")
        .style("font-size", fzinitial)
        .text(function(d) { return d.data.name; });

      d3.selectAll("defs").style("fill-opacity", 1).transition().duration(2000).style("fill-opacity", 0);

      var node = g.selectAll("circle,text.label");

      svg.style("background", "white")
          .on("click", function() {
                    zoom(root);
                    });

      zoomTo([root.x, root.y, root.r * smallr *2 + margin]);


      function zoom(d) {
            var focus0 = focus; focus = d;
            var slapse=500, mlapse=1500, llapse=2000;

            var trans = d3.transition()
            .duration(d3.event.altKey ? 7500 : mlapse)
            .delay(function(d){
              if(focus==root){
                  return mlapse;
              }else{
                  return slapse;
              }
            })
            .tween("zoom", function(d) {
              if(focus==root){
                  var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r *smallr* 2 + margin]);
                  return function(t) { zoomTo(i(t)); };
              }else{
                  if(focus.depth>1){
                  var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 1.7  + margin]);
                  }else{
                  var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2 + margin]);
                  }
                  return function(t) { zoomTo(i(t)); };
              }
            });

            trans.selectAll("circle")
            .filter(function(d) { return (d.depth<=focus.depth+1)  || this.style.display === "inline"; })
            .delay(slapse)
            .style("fill-opacity", function(d) { return (d.depth<=focus.depth+1) ? 1 : 0; })
            .on("start", function(d) { if (d.depth<=focus.depth+1)  this.style.display = "inline"; })
            .on("end", function(d) { if (d.depth>focus.depth+1)  this.style.display = "none"; });

            trans.selectAll("text")
            .filter(function(d) { return d.parent === focus && this.style.display !== "inline"; })
            .delay(mlapse)
            .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
            .styleTween("display", function() { return d3.interpolate("none", "inline"); });

            trans.selectAll("text")
            .filter(function(d) { return this.style.display === "inline"; })
            .delay(slapse)
            .style("fill-opacity", function(d) {return (d.depth<=focus.depth+1 || d===focus)? 1 : 0; })
            .attr("dy", 0)
            .style("font-size", fzinitial)
            .on("start", function(d) {this.style.diplay = "inline"})
            .on("end", function(d) { if (d.depth>focus.depth+1 && d!==focus) this.style.display = "none"; });

            trans.selectAll("text")
            .filter(function(d) { return (this.style.display === "inline") && (d===focus); }).delay(slapse+100)
            .attrTween("dy", function() { return d3.interpolate(0, -300); })
            .styleTween("font-size", function() { return d3.interpolate(fzinitial, fzfocus); });

            /*trans.select("circle#circle-1.node").each(function(d) {console.log(focus.depth);console.log(focus0.depth);});
            trans.select("circle#circle-1.node").transition()
            .delay(function(d){
              if(focus==root){
                  return lapse;
              }else{
                  return 0;
              }
            })
            .duration(1500)
            .styleTween("font-size", function(d){
                                    if(focus.depth==0 && focus0.depth>=2){
                                                    return d3.interpolate("none", "url(#grump_avatar)");}
                                    else if (focus.depth==0 && focus0.depth>0){
                                                    return d3.interpolate("url(#grump_avatar_blur)", "url(#grump_avatar)");}
                                    else if (focus.depth>=2 && focus0.depth>0){
                                                    return d3.interpolate("url(#grump_avatar_blur)", "none");}
                                    });


            if (d.depth>2){d3.select("circle#circle-1.node").transition().delay(750).style("fill", "none");}
            if (d.depth<=2){d3.select("circle#circle-1.node").style("fill", "url(#grump_avatar_blur)").transition().delay(700).style("fill", "url(#grump_avatar_blur)");}*/

            console.log(focus.depth);

            var maincircle = d3.selectAll("circle#circle-1.node");

            if (focus.depth==0){maincircle.style("fill", "url(#grump_avatar)").transition().delay(mlapse).style("fill-opacity", 1);}
            if (focus.depth==1){maincircle.style("fill", "url(#grump_avatar_blur)").transition().style("fill-opacity", 1);}
            if (focus.depth==2){maincircle.style("fill-opacity", 1).transition().duration(mlapse).style("fill-opacity", 0).delay(mlapse).style("fill", "none");}

            if(focus.depth<d.depth && focus.depth!=0 && d.children.length==1){
               d3.select("#htmlfile").attr("src",d.data.name+".html").style("z-index", 2000).transition().delay(mlapse+slapse).style("display", "block");
            }else{
               d3.select("#htmlfile").style("display", "none").style("z-index", -1000);
            }


      }

      function fadding(d){
            
      }

      function zoomTo(v) {
        var k = diameter / v[2]; view = v;
        node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
        circle.attr("r", function(d) { return d.r * k; });
      }
    });


</script>

</body>
</html>

